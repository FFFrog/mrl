# synchronization mechanisms

## volatile

操作系统为了提升内存读写的效率，经常访问的内存，相应数据会被放到cache里面去，这样可以提升读写速度，这样就不会去直接访问内存，但是会存在一个问题，如果内存中的数据被DMA修改的话，内存中数据和cache中的数据就会不一致。

加了volatile关键字，意味着这个内存片段不会被放到cache里面去，每次都要从内存里面去读取，这样就不会出现内存中数据和cache中的数据不一致。关于实现的细节，就拿Linux系统来说，操作系统内核中有一个dma_alloc_coherent函数，这函数申请到的内存，是不会被cache的。其实决定一片内存是否会被cache，是由内存片段的页表（一个页的大小一般是4KB）的描述符里面的一个标志位来确定的，MMU会通过这个标志位来确定这个页是否可以被cache。

如果要深刻理解volatile关键字，必须精通编译器，MMU，操作系统底层实现内存管理的细节。关于DMA是什么？举个栗子，在网卡在接收到数据的时候，需要把数据放到内存里面，如果使用DMA来搬运数据的话，数据会很快，因为用ASIC来搬运数据，比起操作系统用软件来实现肯定快多了，并且操作系统这时可以让CPU腾出来做其他事情。
