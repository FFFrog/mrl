## 1. `ld.so` 在加载主程序时的行为

- **加载所有直接和间接依赖库**：当主程序启动时，`ld.so` 会自动加载主程序的直接依赖库（由 `DT_NEEDED` 标签标识的库），并递归加载这些库的间接依赖。
- **符号加入全局符号表**：无论是直接依赖还是间接依赖，`ld.so` 都会将这些库的符号添加到全局符号表。这样主程序及其加载的所有库在解析符号时，都可以优先在全局符号表中找到所需的符号。

---

## 2. `dlopen` 加载库时的 `RTLD_GLOBAL` 和 `RTLD_LOCAL` 行为

- **`RTLD_GLOBAL`**：当使用 `dlopen` 加载库时，指定 `RTLD_GLOBAL` 标志不仅会将该库的符号添加到全局符号表，还会将其所有间接依赖库的符号也递归地添加到全局符号表。这确保了通过 `dlopen` 加载的库及其间接依赖的符号在全局范围内可见，方便后续符号解析。
- **`RTLD_LOCAL`**：如果使用 `RTLD_LOCAL` 加载库，则该库及其间接依赖库的符号不会加入全局符号表，仅在加载的库本身和使用 `dlsym` 显式查找时可见。

---

## 3. 符号解析顺序

无论库是通过主程序还是 `dlopen` 加载，符号解析顺序遵循以下逻辑：

- **全局符号表优先**：`ld.so` 首先会在全局符号表中查找符号，优先使用全局可见的符号。
- **库本地查找**：如果在全局符号表中未找到符号，`ld.so` 会在调用符号的库本身及其直接依赖中继续查找符号。
- **解析失败**：如果以上查找都无法解析符号，则抛出未定义符号错误（`undefined symbol`）。

---

## 总结

- **主程序加载的所有直接和间接依赖库**的符号都会加入全局符号表。
- **`dlopen` 加载库时的 `RTLD_GLOBAL`** 会将该库及其所有间接依赖库的符号递归加入全局符号表，而 `RTLD_LOCAL` 则不会。
- **符号解析**遵循“全局符号表优先，本地符号表次之”的顺序，以确保解析的兼容性和灵活性。

